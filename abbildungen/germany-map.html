<!--
Prompt:
Create a Javascript snippet that will draw a map of the different states of Germany. 
Each state should have a label with the German name. 
Make sure the labels do not overlap. 
Make sure they are readable. 
Use tasteful colors and clean strokes for the state borders. 
Use an API to pull in geographic data. 
The output should be rendered as an SVG image. Make sure the map is big enough.
-->

<!DOCTYPE html>
<meta charset="utf-8" />
<title>Deutschland – Bundesländer (SVG)</title>
<style>
  body { margin: 0; background: #fafafa; font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  svg { display: block; margin: 0 auto; }
  button {
    display: block;
    margin: 20px auto;
    padding: 10px 18px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    background: #4a90e2;
    color: white;
    cursor: pointer;
  }
  button:hover { background: #357ab7; }
  .state { stroke: #4a4a4a; stroke-width: 1; vector-effect: non-scaling-stroke; }
  .label { font-size: 14px; font-weight: 600; fill: #1e1e1e; paint-order: stroke; stroke: white; stroke-width: 3px; }
  .leader { stroke: #777; stroke-width: 1; stroke-dasharray: 2 3; vector-effect: non-scaling-stroke; }
</style>

<svg id="map" width="1100" height="900" viewBox="0 0 1100 900" aria-label="Karte der Bundesländer in Deutschland"></svg>
<button id="download">Download SVG</button>

<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script>
(async function () {
  const width = 1100, height = 900;
  const svg = d3.select("#map");

  const palette = [
    "#cfe8f3","#fddede","#d9f2e6","#f7e6ff","#fff0cc","#e6f0ff",
    "#fdebd3","#e8f5e9","#f3e5f5","#e0f7fa","#fff3e0","#e8eaf6",
    "#f0f4c3","#ffe0e0","#e0f2f1","#fce4ec"
  ];

  const url = "https://cdn.jsdelivr.net/gh/isellsoap/deutschlandGeoJSON/2_bundeslaender/4_niedrig.geo.json";
  const geo = await fetch(url).then(r => r.json());

  const projection = d3.geoMercator().fitSize([width, height], geo);
  const path = d3.geoPath(projection);

  const gStates = svg.append("g");
  gStates.selectAll("path")
    .data(geo.features)
    .enter()
    .append("path")
    .attr("class", "state")
    .attr("fill", (d, i) => palette[i % palette.length])
    .attr("d", path);

  const anchors = geo.features.map(f => {
    const c = path.centroid(f);
    return {
      name: f.properties.name || f.properties.GEN || f.properties.NAME_1,
      ax: c[0],
      ay: c[1],
      x: c[0],
      y: c[1]
    };
  });

  const gLabels = svg.append("g");
  const labelGroups = gLabels.selectAll("g.labelGroup")
    .data(anchors)
    .enter()
    .append("g")
    .attr("class", "labelGroup");

  const leaders = labelGroups.append("line")
    .attr("class", "leader")
    .attr("x1", d => d.ax)
    .attr("y1", d => d.ay)
    .attr("x2", d => d.x)
    .attr("y2", d => d.y);

  const texts = labelGroups.append("text")
    .attr("class", "label")
    .attr("text-anchor", "middle")
    .attr("x", d => d.x)
    .attr("y", d => d.y)
    .text(d => d.name);

  const approxCharW = 7.2, lineH = 16;
  texts.each(function (d) {
    try {
      const bb = this.getBBox();
      d.r = Math.max(bb.width, bb.height) / 2 + 6;
    } catch {
      d.r = Math.max(d.name.length * approxCharW, lineH) / 2 + 6;
    }
  });

  const sim = d3.forceSimulation(anchors)
    .force("x", d3.forceX(d => d.ax).strength(0.08))
    .force("y", d3.forceY(d => d.ay).strength(0.08))
    .force("collide", d3.forceCollide(d => d.r))
    .stop();
  for (let i = 0; i < 200; i++) sim.tick();

  texts.attr("x", d => d.x).attr("y", d => d.y);
  leaders
    .attr("x1", d => d.ax).attr("y1", d => d.ay)
    .attr("x2", d => d.x).attr("y2", d => d.y);

  const pad = 8;
  texts.attr("x", d => Math.max(pad, Math.min(width - pad, d.x)))
       .attr("y", d => Math.max(pad, Math.min(height - pad, d.y)));
  leaders.attr("x2", function(d,i){ return +texts.nodes()[i].getAttribute("x"); })
         .attr("y2", function(d,i){ return +texts.nodes()[i].getAttribute("y"); });

  // === Download-Button Funktionalität ===
  document.getElementById("download").addEventListener("click", function() {
    const svgNode = document.querySelector("#map");
    const serializer = new XMLSerializer();
    let source = serializer.serializeToString(svgNode);
    source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
    const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
    const link = document.createElement("a");
    link.href = url;
    link.download = "deutschland_bundeslaender.svg";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
})();
</script>
